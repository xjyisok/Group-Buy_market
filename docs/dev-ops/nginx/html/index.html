<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweater - æ‹¼å›¢é¡¹ç›® - å•†å“è¯¦æƒ…é¡µ</title>
    <link rel="stylesheet" href="css/index.css">
    <style>
        /* ä¸ºæˆ‘çš„æ‹¼å›¢æŒ‰é’®å’Œå…¶ä»–äººæ‹¼å›¢æŒ‰é’®æ·»åŠ ä¸åŒæ ·å¼ */
        .my-group-btn {
            background-color: #4CAF50 !important; /* ç»¿è‰²è¡¨ç¤ºæˆ‘çš„æ‹¼å›¢ */
            color: white !important;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .other-group-btn {
            background-color: #FF5722 !important; /* æ©™è‰²è¡¨ç¤ºå…¶ä»–äººæ‹¼å›¢ */
            color: white !important;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        /* é¼ æ ‡æ‚¬åœæ•ˆæœ */
        .my-group-btn:hover {
            background-color: #45a049 !important;
        }

        .other-group-btn:hover {
            background-color: #E64A19 !important;
        }

        /* ç¦ç”¨çŠ¶æ€ */
        .my-group-btn:disabled,
        .other-group-btn:disabled {
            background-color: #cccccc !important;
            cursor: not-allowed;
        }

        /* ä¸ºæˆ‘çš„æ‹¼å›¢é¡¹æ·»åŠ ç‰¹æ®Šæ ·å¼ */
        .user-team {
            background-color: #f0f9ff !important; /* æµ…è“è‰²èƒŒæ™¯ */
            border-left: 4px solid #4CAF50 !important; /* ç»¿è‰²è¾¹æ¡† */
        }

        /* åº•éƒ¨æŒ‰é’®æ ·å¼ä¿æŒä¸å˜ */
        .group-buy {
            background-color: #FF5722 !important; /* æ©™è‰² */
            color: white !important;
        }

        .buy-alone {
            background-color: #2196F3 !important; /* è“è‰² */
            color: white !important;
        }
    </style>
</head>
<body>
<!-- è½®æ’­å›¾ -->
<div class="swiper-container">
    <div class="swiper-wrapper">
        <div class="swiper-slide"><img src="./images/sku-13811216-01.png"></div>
        <div class="swiper-slide"><img src="./images/sku-13811216-02.png"></div>
        <div class="swiper-slide"><img src="./images/sku-13811216-03.png"></div>
    </div>
    <div class="swiper-pagination"></div>
</div>

<!-- å•†å“ä¿¡æ¯ -->
<div class="product-info">
    <h1 class="product-title">æ‰‹å†™MyBatisï¼šæ¸è¿›å¼æºç å®è·µï¼ˆå…¨å½©ï¼‰</h1>
    <span class="promotion-tag">å¤§ä¿ƒä¼˜æƒ </span>
    <span class="promotion-text"></span> <!-- åŠ¨æ€å¡«å……ä¿ƒé”€æ–‡æœ¬ -->
</div>

<!-- æ‹¼å•åˆ—è¡¨å®¹å™¨ -->
<div class="group-list">
    <!-- åŠ¨æ€ç”Ÿæˆæ‹¼å›¢åˆ—è¡¨ -->
</div>

<!-- ç©ºç™½åŒºåŸŸ -->
<div class="area"></div>

<!-- åº•éƒ¨æ“ä½œæ  -->
<div class="action-bar">
    <button class="action-btn buy-alone"></button>
    <button class="action-btn group-buy"></button>
</div>

<script src="js/index.js"></script>
<script>
    // æ–°å¢æ”¯ä»˜ç¡®è®¤å‡½æ•°
    function showPaymentConfirm(price) {
        // åˆ›å»ºé®ç½©å±‚
        const overlay = document.createElement('div');
        overlay.className = 'payment-overlay';

        // åˆ›å»ºå¼¹çª—å†…å®¹
        const modal = document.createElement('div');
        modal.className = 'payment-modal';
        modal.innerHTML = `
        <h3>æ”¯ä»˜ç¡®è®¤</h3>
        <p>å•†å“é‡‘é¢ï¼šï¿¥${price}</p>
        <p>ä¹°å®¶è´¦å·ï¼š<span class="copyable" data-copy="kvhmoj3832@sandbox.com">kvhmoj3832@sandbox.com</span></p>
        <p>ç™»å½•å¯†ç ï¼š111111</p>
        <p>æ”¯ä»˜å¯†ç ï¼š111111</p>
        <div class="modal-buttons">
            <button class="confirm-btn">ç¡®è®¤æ”¯ä»˜</button>
            <button class="cancel-btn">å–æ¶ˆæ”¯ä»˜</button>
        </div>
    `;

        // ç¡®è®¤æ”¯ä»˜å¤„ç†
        modal.querySelector('.confirm-btn').addEventListener('click', function() {
            const form = document.querySelector('form');
            if (form) form.submit();
            overlay.remove();
        });

        // å–æ¶ˆæ”¯ä»˜å¤„ç†
        modal.querySelector('.cancel-btn').addEventListener('click', function() {
            document.querySelectorAll('form').forEach(form => form.remove());
            overlay.remove();
        });

        // æ·»åŠ å¤åˆ¶åŠŸèƒ½
        modal.querySelector('.copyable').addEventListener('click', function() {
            const textToCopy = this.getAttribute('data-copy');
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('ä¹°å®¶è´¦å·å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                console.error('æ— æ³•å¤åˆ¶æ–‡æœ¬: ', err);
            });
        });

        overlay.appendChild(modal);
        document.body.appendChild(overlay);
    }

    function obfuscateUserId(userId) {
        if (userId.length <= 4) {
            return userId;
        } else {
            const start = userId.slice(0, 2);
            const end = userId.slice(-2);
            const middle = '*'.repeat(userId.length - 4);
            return `${start}${middle}${end}`;
        }
    }

    // æ ¼å¼åŒ–ç”¨æˆ·IDæ˜¾ç¤ºï¼šæœ€å¤šæ˜¾ç¤º5ä¸ªç”¨æˆ·
    function formatUserIds(userIds, currentUserId) {
        if (!userIds || userIds.length === 0) return '';

        // å¯¹æ¯ä¸ªç”¨æˆ·IDè¿›è¡Œè„±æ•å¤„ç†
        const obfuscatedIds = userIds.map(id => obfuscateUserId(id));

        // é™åˆ¶æœ€å¤šæ˜¾ç¤º5ä¸ª
        if (obfuscatedIds.length <= 5) {
            return obfuscatedIds.join('ã€');
        } else {
            return obfuscatedIds.slice(0, 5).join('ã€') + 'ç­‰';
        }
    }

    // åˆ¤æ–­æ˜¯å¦ä¸ºç”¨æˆ·è‡ªå·±çš„æ‹¼å›¢
    function isUserTeam(team, currentUserId) {
        // æœ‰outTradeNoè¡¨ç¤ºæ˜¯ç”¨æˆ·è‡ªå·±çš„æ‹¼å›¢
        if (team.outTradeNo) return true;

        // æˆ–è€…æ£€æŸ¥userIdsä¸­æ˜¯å¦åŒ…å«å½“å‰ç”¨æˆ·
        return team.userIds && team.userIds.includes(currentUserId);
    }

    // åˆ¤æ–­å›¢é˜Ÿæ˜¯å¦å·²æ»¡ï¼ˆæ— æ³•å†åŠ å…¥ï¼‰
    function isTeamFull(team) {
        return team.lockCount >= team.targetCount;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // æ ¹æ®æµ‹è¯•è¯‰æ±‚ï¼Œè®¾ç½®åŸºç¡€åœ°å€
        var sPayMallUrl = "http://127.0.0.1:9091";
        var groupBuyMarketUrl = "http://127.0.0.1:8092";
        var goodsId = "9890001";

        // è·å–ä¿¡æ¯
        var userId = getCookie("loginToken");
        if (!userId) {
            window.location.href = "login.html"; // è·³è½¬åˆ°ç™»å½•é¡µ
            return;
        }

        // è¯·æ±‚æ¥å£æ•°æ®
        fetch(groupBuyMarketUrl + '/api/v1/gbm/index/query_group_buy_market_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                userId: userId,
                source: "s01",
                channel: "c01",
                goodsId: goodsId
            })
        })
            .then(response => response.json())
            .then(res => {
                if(res.code !== '0000') return;

                const { activityId, goods, teamList, teamStatistic } = res.data;
                const groupList = document.querySelector('.group-list');
                const promotionText = document.querySelector('.promotion-text');

                // æ›´æ–°ä¿ƒé”€ä¿¡æ¯
                promotionText.textContent = `ç›´é™ Â¥${goods.deductionPrice.toFixed(0)}ï¼Œ${teamStatistic.allTeamUserCount}äººå†æŠ¢ï¼Œå‚ä¸é©¬ä¸ŠæŠ¢åˆ°`;

                // æ¸…ç©ºå¹¶ç”Ÿæˆæ‹¼å›¢åˆ—è¡¨
                groupList.innerHTML = '';

                if (teamList.length === 0) {
                    groupList.innerHTML = `
                <div class="group-item empty-tips">
                    <div class="tips-content">
                        å°ä¼™ä¼´ï¼Œèµ¶ç´§å»å¼€å›¢å§ï¼Œåšæ‘é‡Œæœ€é“çš„ä»”ï¼ğŸ‰
                    </div>
                </div>
            `;
                } else {
                    // å¯¹å›¢é˜Ÿåˆ—è¡¨è¿›è¡Œæ’åºï¼šç”¨æˆ·è‡ªå·±çš„å›¢é˜Ÿç½®é¡¶
                    const sortedTeamList = [...teamList].sort((a, b) => {
                        const aIsUserTeam = isUserTeam(a, userId);
                        const bIsUserTeam = isUserTeam(b, userId);

                        if (aIsUserTeam && !bIsUserTeam) return -1;
                        if (!aIsUserTeam && bIsUserTeam) return 1;
                        return 0;
                    });

                    sortedTeamList.forEach(team => {
                        const remaining = team.targetCount - team.lockCount;
                        const userDisplayText = formatUserIds(team.userIds, userId);
                        const isMyTeam = isUserTeam(team, userId);
                        const isFull = isTeamFull(team);

                        // ç¡®å®šæŒ‰é’®æ–‡æœ¬å’Œç±»å
                        let buttonText, buttonClass;
                        if (isMyTeam) {
                            buttonText = isFull ? "æˆ‘çš„æ‹¼å›¢(å·²æ»¡)" : "æˆ‘çš„æ‹¼å›¢";
                            buttonClass = "my-group-btn";
                        } else {
                            buttonText = isFull ? "å‚ä¸æ‹¼å›¢(å·²æ»¡)" : "å‚ä¸æ‹¼å›¢";
                            buttonClass = "other-group-btn";
                        }

                        groupList.innerHTML += `
                    <div class="group-item ${isMyTeam ? 'user-team' : ''}">
                        <div>
                            <div class="user-info" data-teamId="${team.teamId}" data-activityId="${team.activityId}">${userDisplayText}</div>
                            <div class="group-status">
                                <span>ç»„é˜Ÿä»…å‰©${remaining}äººï¼Œæ‹¼å•å³å°†ç»“æŸ</span>
                                <span class="countdown">${team.validTimeCountdown}</span>
                            </div>
                        </div>
                        <div class="right">
                            <button class="${buttonClass}" data-price="${goods.payPrice.toFixed(0)}" data-teamid="${team.teamId}" ${isFull ? 'disabled' : ''}>${buttonText}</button>
                        </div>
                    </div>
                `;
                    });
                }

                // æ›´æ–°åº•éƒ¨æŒ‰é’®
                const buyAloneBtn = document.querySelector('.buy-alone');
                const groupBuyBtn = document.querySelector('.group-buy');
                buyAloneBtn.textContent = `å•ç‹¬è´­ä¹°(ï¿¥${goods.originalPrice.toFixed(0)})`;
                buyAloneBtn.dataset.price = goods.originalPrice;
                groupBuyBtn.textContent = `å¼€å›¢è´­ä¹°(ï¿¥${goods.payPrice.toFixed(0)})`;
                groupBuyBtn.dataset.price = goods.payPrice;

                // ç»‘å®šæ”¯ä»˜äº‹ä»¶[æ‹¼å›¢è´­ä¹°]
                document.querySelectorAll('.my-group-btn, .other-group-btn, .group-buy').forEach(btn => {
                    btn.addEventListener('click', function() {
                        // å¦‚æœæŒ‰é’®è¢«ç¦ç”¨ï¼ˆæ‹¼å›¢å·²æ»¡ï¼‰ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
                        if (this.disabled) return;

                        const button = this;
                        const price = button.dataset.price;

                        // è·å–æ‹¼å›¢ID
                        let teamId = null;
                        if (this.classList.contains('my-group-btn') || this.classList.contains('other-group-btn')) {
                            teamId = button.dataset.teamid;
                        }

                        var url = sPayMallUrl + '/api/v1/alipay/create_pay_order';

                        var requestBody = {
                            userId: userId,
                            productId: goods.goodsId,
                            teamId: teamId,
                            activityId: activityId,
                            marketType: 1
                        };

                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        })
                            .then(response => response.json())
                            .then(json => {
                                if (json.code === "0000") {
                                    document.querySelectorAll('form').forEach(form => form.remove());
                                    document.body.insertAdjacentHTML('beforeend', json.data);
                                    showPaymentConfirm(goods.payPrice);
                                } else {
                                    console.error('Error:', json.info);
                                }
                            })
                            .catch(error => console.error('Error:', error));
                    });
                });

                // ç»‘å®šæ”¯ä»˜äº‹ä»¶[å•ç‹¬è´­ä¹°]
                document.querySelectorAll('.buy-alone').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const button = this;
                        const price = button.dataset.price;

                        var requestBody = {
                            userId: userId,
                            productId: goods.goodsId,
                            marketType: 0
                        };

                        fetch(sPayMallUrl + '/api/v1/alipay/create_pay_order', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        })
                            .then(response => response.json())
                            .then(json => {
                                if (json.code === "0000") {
                                    document.querySelectorAll('form').forEach(form => form.remove());
                                    document.body.insertAdjacentHTML('beforeend', json.data);
                                    showPaymentConfirm(goods.payPrice);
                                } else {
                                    console.error('Error:', json.info);
                                }
                            })
                            .catch(error => console.error('Error:', error));
                    });
                });

                // å¯åŠ¨å€’è®¡æ—¶
                document.querySelectorAll('.countdown').forEach(el => {
                    new Countdown(el, el.textContent);
                });
            });
    });
</script>
</body>
</html>